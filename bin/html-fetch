#! /usr/bin/env node

/**
 * @file html-fetch.js
 * @author Lasha Badashvili (lashab@picktek.com)
 *
 * Fetches sitemap URIs & downloads HTML content.
 */

'use strict';

/**
 * Module dependencies.
 */
var format    = require('util').format;
var stream    = require('stream');
var join      = require('path').join;
var fs        = require('fs');
var XMLStream = require('xml-stream');
var request   = require('request');
var colors    = require('colors');
var argv      = require('yargs').argv;

var _map = {};
// Get uri.
var uri = argv.uri;
// Get directory.
var dir = argv.dir;
// Get map directory.
var map = argv.map;
if (!uri || !dir) {
  throw new Error('Mandatory arguments are missing html-fetch --uri [URI] --dir [path/to/directory]'.red);
}
// Create directory.
fs.mkdir(dir, function(error) {
  var regex      = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
  var data       = '';
  var i          = 0;
  var indexCount = -1;
  var log        = [];


  // Check URI.
  uri = uri && regex.test(uri) ? uri : (function() {
    throw new Error(format('%s isn\'t valid uri, please provide correct --uri argument.'.red, uri));
  })();
  // Do HTTP call for sitemap XML URI.
  request(uri).on('data', function(string) {
    data += string;
  }).on('end', function() {
    var _stream = new stream.PassThrough();
    // Store data.
    _stream.end(data);
    var XML = new XMLStream(_stream);
    XML.on('endElement: loc', function(item) {
      // Download HTML content.
      download(item.$text, i, function(_map) {
        var data = JSON.stringify(_map);
        if (map && typeof map === 'string') {
          // Create directory.
          fs.mkdir(map, function(error) {
            // Create map.json file.
            // Write - filename:url JSON object.
            var stream = fs.createWriteStream(join(map, 'map.json'));
            stream.write(data);
            stream.end();
          });
          indexCount--;
        }
        else { 
          // Log data.
          log.push(_map);
          indexCount--;
          if (indexCount == 0) {
            for (var i = 0, len = log.length; i < len; i++) {
              console.log(JSON.stringify(log[i], null, ' '));
            }
          }
        }
      });
      i++;
      indexCount = Math.max(indexCount, i);
    });
  }).on('error', function(error) {
    throw new Error(format('%s'.red, error));
  }).end();
});

/**
 * @callback download - Get HTML content & store in file.
 *
 * @param {String} url
 * @param {Number} key
 * @param {Function} callback
 */
function download(url, key, callback) {
  // Create unique filename.
  var filename = format('sitemap-%d.html', key);
  // Get directory.
  var dirctory = dir.replace(/\/$/, '');
  // Create write stream.
  var stream = fs.createWriteStream(join(dirctory, filename));
  // Store key:value of filename:url
  _map[filename] = url;
  // Do HTTP call for each of the URL & get HTML content.
  // Write HTML content in file.
  request(url).on('data', function(data) {
    // Write stream.
    stream.write(data);
  }).on('end', function() {
    // Stream - end.
    stream.end();
    // Log filename.
    console.log('%s has been added.', filename.green);

    callback(_map);
  }).on('error', function(error) {
    // Stream - close.
    stream.close();
    throw new Error(format('%s'.red, error));
  }).end();
};
