#! /usr/bin/env node

/**
 * @file html-fetch.js
 * @author Lasha Badashvili (lashab@picktek.com)
 *
 * Fetches sitemap URIs & downloads HTML content.
 */

'use strict';

/**
 * Module dependencies.
 */
var format = require('util').format;
var stream = require('stream');
var path = require('path');
var fs = require('fs');
var XMLStream = require('xml-stream');
var request = require('request');
var colors = require('colors');
var mkdirp = require('mkdirp');
var argv = require('yargs').argv;

process.on('uncaughtException', function (error) {
  // Log errors.
  process.stdout.write(error.message + '\n');
  process.exit(1);
});

var help = "html-fetch usage:\n" +
  "\thtml-fetch [options]\n" +
  "Options\n" +
  "\t--help                     Display this error message\n" +
  "\t--uri  [URI]  (required)   Path or URL to XML Sitemap file.\n" +
  "\t--dir  [path] (required)   Directory to output HTML files.\n" +
  "\t--map  [file] (optional)   File to output JSON that maps file names to URLs. If not set, sends to stdout\n";

if (argv.help) {
  process.stdout.write(help.yellow + '\n');
  process.exit(0);
}

var _map = {};
// Get uri.
var uri = argv.uri;
// Get directory.
var dir = argv.dir;
// Get map directory.
var map = argv.map;
if (!uri || !dir) {
  process.stdout.write(help.yellow + '\n');
  process.exit(0);
}

// Create directory.
process.umask(0);
mkdirp(path.normalize(dir), '0777', function(error) {
  if (error) {
    throw new Error(format('%s'.red, error));
  }
  var regex      = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
  var data       = '';
  var i          = 0;
  var j = -1;
  var log        = [];
  // Check URI.
  uri = uri && regex.test(uri) ? uri : (function() {
    throw new Error(format('%s isn\'t valid uri, please provide correct --uri argument.'.red, uri));
  })();
  // Do HTTP call for sitemap XML URI.
  request(uri).on('data', function(string) {
    data += string;
  }).on('end', function() {
    var _stream = new stream.PassThrough();
    // Store data.
    _stream.end(data);
    var XML = new XMLStream(_stream);
    XML.on('endElement: loc', function(item) {
      // Download HTML content.
      download(item.$text, i, function(_map) {
        var data = JSON.stringify(_map);
        if (map && typeof map === 'string') {
          // Get map directory path.
          var dirname = path.dirname(path.normalize(map));
          // Create directory.
          process.umask(0)
          mkdirp(dirname, '0777', function(error) {
            if (error) {
              throw new Error(format('%s'.red, error));
            }
            // Get map basename.
            var basename = path.basename(map).split('.');
            // Create [MAP].json file.
            var mapJSON = path.join(dirname, basename[0] + '.json');
            // Write - filename:url JSON object.
            var stream = fs.createWriteStream(mapJSON);
            stream.write(data);
            stream.end();
          });
          j--;
        }
        else {
          // Log data.
          log.push(_map);
          j--;
          if (j == 0) {
            for (var i = 0, length = log.length; i < length; i++) {
              console.log(JSON.stringify(log[i], null, ' '));
            }
          }
        }
      });
      i++;
      j = Math.max(j, i);
    });
  }).on('error', function(error) {
    throw new Error(format('%s'.red, error));
  }).end();
});

/**
 * @callback download - Get HTML content & store in file.
 *
 * @param {String} url
 * @param {Number} key
 * @param {Function} callback
 */
function download(url, key, callback) {
  // Create unique filename.
  var filename = format('sitemap-%d.html', key);
  // Get directory.
  var dirctory = dir.replace(/\/$/, '');
  // Create write stream.
  var stream = fs.createWriteStream(path.join(dirctory, filename));
  // Store key:value of filename:url
  _map[filename] = url;
  // Do HTTP call for each of the URL & get HTML content.
  // Write HTML content in file.
  request(url).on('data', function(data) {
    // Write stream.
    stream.write(data);
  }).on('end', function() {
    // Stream - end.
    stream.end();
    // Log filename.
    console.log('%s has been added.', filename.green);
    callback(_map);
  }).on('error', function(error) {
    // Stream - close.
    stream.close();
    throw new Error(format('%s'.red, error));
  }).end();
};
