#! /usr/bin/env node

/**
 * @file html5-audit.js
 * @author Lasha Badashvili (lashab@picktek.com)
 *
 * Scan HTML files (using html5-lint module).
 */

'use strict';

/**
 * Module dependencies.
 */
var format = require('util').format;
var fs = require('fs');
var html5Lint = require('html5-lint');
var colors = require('colors');
var argv = require('yargs').argv;
var _ = require('underscore');
var report = require('../helpers/report');
var files = require('../helpers/files');

var _data = [];

try {
  // Get path to file.
  var path = argv.path;
  // Get report directory.
  var _report = argv.report || '';
  // Get errors only.
  var errorsOnly = argv['errors-only'] || false;
  if (!path) {
    throw new Error('Mandatory arguments are missing html5-audit --path [path/to/file(s)]'.red);
  }
  var i = 1;
  // Get file(s).
  files(path, argv._, function(file, length) {
    // Get content.
    fs.readFile(file, 'utf-8', function(error, content) {
      if (error) {
        throw new Error(format('%s'.red, error));
      }
      // Test file.
      html5Lint(content, {
        errorsOnly: errorsOnly
      }, function(error, data) {
        if (error) {
          throw new Error(format(error).red);
        }
        if (data.messages.length) {
          // Log file scanning.
          console.log('Scanning %s'.green, file);
          data.messages.forEach(function(object) {
            // Add filename.
            object.filename = file;
            // Store result in _data variable.
            _data.push(object);
          });
          if (i === length) {
            // Create report.
            report({
              html5: _.groupBy(_data, 'filename')
            }, _report, 'html5-report.json');
          }
          i++;
        }
      });
    });
  });
}
catch (e) {
  // Log exception message.
  console.log(e.message);
};
